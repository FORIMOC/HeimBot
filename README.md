# HelmBot V1.0.0

<u>2022/1/26</u>



此正式版本基本实现了预想的功能，项目可视化展示地址：https://forimoc.com/forimocV2/Helmboard/

## 简介

HelmBot后端代码通过Hoshino/index.php来接收go-cqhttp原生机器人框架的POST转发消息并处理数据，可以达到监听QQ群消息，分析用户关系网络并可视化，检测消息关键词并高亮报警等功能



## 此正式版本功能

#### 1.可视化用户关系网络

​		以关系图的方式展示用户关系网络，则源数据的形式为邻接矩阵，通过建立`Hoshino_graph`数据表来存储并更新群聊中关系网络的源数据
​		群聊中每记录一条消息都会记录这条消息的前5条消息的用户id，当一个用户发言后，另一个用户在5条消息内发言，则记为对前者用户有社交倾向，`Hoshino_graph`中对应的有向边的`value`字段值增加，根据这个模型模拟用户社交关系网络



#### 2.用户发言频率记录

​		群聊中用户每发一条消息，`Hoshino_users`表中就会更新`freq`字段，同时表中数据充当Helmboard中的扇形图中的数据来源



#### 3.群聊最近5条发言记录

​		`Hoshino_premessages`表不断更新维护群聊中最近5条的消息，同时Helmboard中的消息展示框取得这些消息展示



#### 4.关键词检测并高亮报警

​		消息展示框展示消息之前首先进行一层过滤，检测消息中的关键词，给其加上css样式以高亮，同时令Hoshino主动在特定的群聊或私聊发出消息报警



#### 5.简单可控的监听

- 使用者可以在QQ中(Hoshino存在的群聊)输入例如`开启监听/关闭监听 [群号]`指令来开启或关闭监听
- 使用者可以在QQ中(Hoshino存在的群聊)输入例如`开启报警/关闭报警`指令来开启或关闭监听
- 使用者可以在QQ中(Hoshino存在的群聊)输入例如`查询群聊`指令来查询Hoshino所在监听的群聊
- 使用者可以在QQ中(Hoshino存在的群聊/私聊)输入例如`查询群聊重合度 [群号1] [群号2]`指令来查询两个群聊的用户重合度



## 开发中遇到过的问题

- `user_id`和`group_id`字段类型不能使用默认的`int(11)`：原因是有些用户或群聊的QQ数字值大于$2^{32}-1$，会使字段数据溢出，解决办法是将类型改为`varchar(15)`
- 非普通消息(戳一戳、撤回、匿名消息等)出现时`user_id`和`username`这样的字段值获取不到：原因涉及QQ接口，解决办法是过滤掉这些非普通消息，不记录在整个体系中



## 此版本的数据库接口



- `Hoshino_graph`表：存储Helmboard可视化图表的数据来源

| 列名      | 类型        | 说明                     |
| --------- | ----------- | ------------------------ |
| id        | int(11)     | 主键                     |
| group_id  | varchar(15) | 群id                     |
| user1_id  | varchar(15) | 用户1id                  |
| user1name | varchar(15) | 用户2名称                |
| user2_id  | varchar(15) | 用户2id                  |
| user2name | varchar(15) | 用户2名称                |
| value     | int(11)     | 用户1对用户2的社交倾向值 |



- `Hoshino_messages`表：记录每条消息

| 列名          | 类型          | 说明                        |
| ------------- | ------------- | --------------------------- |
| id            | int(11)       | 主键                        |
| user_id       | varchar(15)   | 发送消息的用户id            |
| group_id      | varchar(15)   | 该消息所在的群id            |
| time          | int(11)       | 时间戳                      |
| content       | varchar(1000) | 内容                        |
| pre_5users_id | varchar(80)   | 该消息的前5条消息的发送者id |



- `Hoshino_premessages`表：缓存每条消息的前5条消息

| 列名     | 类型          | 说明                                         |
| -------- | ------------- | -------------------------------------------- |
| id       | int(11)       | 主键                                         |
| user_id  | varchar(15)   | 发送消息的用户id                             |
| username | varchar(255)  | 发送消息的用户名                             |
| group_id | varchar(15)   | 该消息所在的群id                             |
| content  | varchar(1000) | 消息内容                                     |
| mark     | int(11)       | 先后顺序标记(1~5，1为距离该条消息最近的消息) |



- `Hoshino_status`表：机器人状态控制

| 列名           | 类型        | 说明                       |
| -------------- | ----------- | -------------------------- |
| id             | int(11)     | 主键                       |
| group_id       | varchar(15) | 群id                       |
| status_record  | int(11)     | 监听状态(1为开启，0为关闭) |
| status_warning | int(11)     | 报警状态(1为开启，0为关闭) |



- `Hoshino_users`表：记录每个发言用户

| 列名     | 类型         | 说明           |
| -------- | ------------ | -------------- |
| id       | int(11)      | 主键           |
| user_id  | varchar(15)  | 用户id         |
| username | varchar(255) | 用户名         |
| group_id | varchar(15)  | 所在群id       |
| freq     | int(11)      | 发送消息总次数 |

